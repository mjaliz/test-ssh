name: Deploy front staging
on:
  push
jobs:
  Deploy-Front-Staging:
    runs-on: self-hosted
    steps:
      - name: SSH remote commands
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_SERVER_IP }}
          port: ${{ secrets.STAGING_SERVER_PORT }}
          username: ${{ secrets.STAGING_SERVER_USER }}
          key: ${{ secrets.STAGING_SERVER_ID_RSA }}
          script: |
            cd ${{ vars.STAGING_PROJECT_DIRECTORY }}
            cd node/src
            git pull
            cd ../..
            docker-compose build
            docker-compose push
            docker stack deploy -c docker-compose.yml learnit_front
      - run: while  ! curl -sI ${{ vars.STAGING_FRONT_BASE_URL }} | grep 200; do sleep 1; done && echo "server is running"
